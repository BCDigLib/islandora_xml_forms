<?php

// $Id$

/**
 * @file
 *
 */

/**
 * Implementation of Hook Menu.
 *
 * @return array
 */
function xml_form_api_menu() {
  $items['FormDefinition.xsd'] = array(
    'title' => 'Form Definition',
    'description' => 'Returns FormDefinition.xsd',
    'page callback' => 'xml_form_api_get_form_defintion',
    'type' => MENU_CALLBACK,
  );
  $items['test'] = array(
    'title' => 'Test',
    'description' => 'test',
    'page callback' => 'xml_form_api_test',
    'access arguments' => array('administer access control'),
    'type' => MENU_CALLBACK,
  );
  return $items;
}

/**
 * Menu Callback, returns FormDefinition.xsd
 */
function xml_form_api_get_form_defintion() {
  
}

/**
 * 
 */
function xml_form_api_test() {
  /* module_load_include('inc', 'xml_form_api', 'FormDefinition');
    module_load_include('inc', 'xml_form_api', 'Form');
    module_load_include('inc', 'xml_form_api', 'FormStorage');
    $basic = <<<EOT
    <element key="a">
    <children>
    <element key="a>a">
    <children>
    <element key="a>a>a">
    <children>
    <element key="a>a>a>a">
    </element>
    </children>
    </element>
    </children>
    </element>
    <element key="a>b"></element>
    <element key="a>c">
    <children>
    <element key="a>c>a"></element>
    </children>
    </element>
    </children>
    </element>
    EOT;
    $xml = simplexml_load_string($basic);
    $form_element = new FormElement($xml);
    var_dump($form_element);
    $itoritor = new RecursiveIteratorIterator(new RecursiveArrayIterator(array('foo'=>$form_element)), RecursiveIteratorIterator::SELF_FIRST);
    echo '&&&&&&&&&</br>';
    foreach ($itoritor as $b => $c) {
    var_dump($b, $c);
    echo '-----</br>';
    }
    return; */
  module_load_include('inc', 'xml_form_api', 'FormElement');
  module_load_include('inc', 'xml_form_api', 'Form');
  $obj = new FormElement();
  $foo = new FormElement();
  $obj->name = "obj";
  $foo->name = "foo";
  //$foo->name = 'foo';
  $obj['foo'] = $foo;
  $foo['boo'] = $boo = FormElement::createFromXMLDefiniton('<element key="boo"><type>textfield</type></element>');
  $elements = new FormElements(Form::ROOT);
  $elements->root['obj'] = $obj;
  $form = $elements->toDrupalForm();
  var_dump($elements->root);
  var_dump($form[Form::ROOT]['obj']);
  var_dump($boo->toDrupalForm());
  return;
  //var_dump($elements->toArray());
  //var_dump($obj->asXML());
  
  //$obj->addChild($foo);
  /*$obj->a = 'sub';
  $obj->b = 'sub';
  $obj->__toString = function() {
        return "{$this->a},{$this->b}";
      };*/
  $a = array(
      'a' => array($obj),
      'b' => 'c'
      );
  
  
  //$blah = new RecursiveCachingIterator(new RecursiveArrayIterator($a), RecursiveCachingIterator::CATCH_GET_CHILD);
  $blah = new RecursiveIteratorIterator(new RecursiveArrayIterator($elements->root), RecursiveIteratorIterator::SELF_FIRST);
  
  foreach ($blah as $q => $z) {
    echo "$q => " . print_r($z, true);
    echo '</br>---</br>';
  }
  return;
  foreach ($blah as $q => $z) {
    echo "$q => " . print_r($z, true);
    echo '</br>---</br>';
  }
  exit();
  foreach ($blah as $q => $z) {
    echo "$q => " . print_r($z, true);
    echo '</br>---</br>';
  }
  echo 'end';
  //return drupal_get_form('xml_form');
}

function xml_form(&$form_state) {

  $xml = <<<EOT
  <form xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:noNamespaceSchemaLocation="http://localhost/FormDefinition.xsd">
    <properties>
        <document_properties>
            <root>mods:mods</root>
            <namespaces>
                <namespace prefix="mods">http://www.loc.gov/mods/v3</namespace>
            </namespaces>
            <schema name="mods">http://www.loc.gov/standards/mods/v3/mods-3-4.xsd</schema>
        </document_properties>
    </properties>
    <elements>
        <element key="a">
            <type>fieldset</type>
            <title>test</title>
            <tree>true</tree>
            <children>
                <element key="b">
                    <type>fieldset</type>
                    <tree>false</tree>
                    <children>
                        <element key="d">
                            <type>fieldset</type>
                            <tree>true</tree>
                            <children>
                                <element key="e">
                                    <type>textfield</type>
                                    <default_value>0ne</default_value>
                                </element>
                                <element key="f">
                                    <type>fieldset</type>
                                    <tree>true</tree>
                                    <children>
                                        <element key="g">
                                            <type>textfield</type>
                                            <default_value>bluene</default_value>
                                        </element>
                                    </children>
                                </element>
                            </children>
                        </element>
                    </children>
                </element>
                <element key="c">
                    <type>textfield</type>
                    <title>title</title>
                    <xml_properties>
                        <create>
                            <parent_path>/mods:mods</parent_path>
                            <schema_path name="mods">/xs:schema/xs:element[@key='title']</schema_path>
                            <element>mods:title</element>
                        </create>
                    </xml_properties>
                </element>
                <element>
                    <type>submit</type>
                    <value>submit</value>
                </element>
            </children>
        </element>
    </elements>
</form>

EOT;
  module_load_include('inc', 'xml_form_api', 'FormDefinition');
  module_load_include('inc', 'xml_form_api', 'Form');
  module_load_include('inc', 'xml_form_api', 'FormStorage');
  $storage = new FormStorage($form_state);
  $doc = new DOMDocument();
  $doc->loadXML($xml);
  $form_state['storage']['test'] = $doc;
  $form = new Form($storage);
  if ($form->isInitialized()) { // Was initialized from storage.
    return $form->toArray();
  }
  else {
    $definition = new FormDefinition($xml);
    $count = 0;
    // var_dump($definition->elements->root);

    $itor = $definition->elements; //->_root->children;//getIterator();
    //$itor = new RecursiveIteratorIterator($root); 
    foreach ($definition->elements as $a => $b) {
      echo '----</br>';
      var_dump($a);
    }
    return;
    foreach ($definition->elements as $a => $b) {
      var_dump($a);
    }
    $definition->elements->add(new FormElement());
    return;
    $xml_document_properties = $definition->getDocumentProperties();
    $xml_document = new XMLDocument($xml_document_properties);
    $form->initialize($definition, $xml_document); // Hidden Params for extra, but at very least we need the definition.
    return $form->toArray();
  }
}

function xml_form_validate($form, &$form_state) {
  $storage = new FormStorage($form_state);
  $_form = new Form($storage);
  //$_form->validate($form, $form_state);
}

function xml_form_submit($form, &$form_state) {
  var_dump($form_state['storage']['test']->documentElement->tagName);
  $storage = new FormStorage($form_state);
  $form = new Form($storage);
  //$form->submit($form, $form_state);
}
